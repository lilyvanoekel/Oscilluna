<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Waveform Encoding and Decoding</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: Arial, sans-serif;
      }
      canvas {
        border: 1px solid #000;
        margin: 20px 0;
      }
      textarea {
        width: 80%;
        height: 100px;
      }
      button {
        margin-top: 10px;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Waveform Encoding and Decoding</h1>

    <textarea
      id="waveformInput"
      placeholder="Paste your waveform array here..."
    ></textarea>
    <button onclick="processWaveform()">Process Waveform</button>

    <canvas id="originalCanvas" width="1024" height="200"></canvas>
    <canvas id="decodedCanvas" width="1024" height="200"></canvas>

    <script>
      const NUMBER_OF_POINTS = 20; // Define the number of control points

      function encodeWaveformToBezierControlPoints(waveform) {
        const controlPoints = [];
        const segmentCount = NUMBER_OF_POINTS - 1; // We have n-1 segments for n points
        const segmentLength = Math.floor(waveform.length / segmentCount);

        for (let i = 0; i < segmentCount; i++) {
          const P0 = waveform[i * segmentLength]; // Start of the segment
          const P3 = waveform[(i + 1) * segmentLength]; // End of the segment

          // Approximate control points P1 and P2 by averaging the points in the middle of the segment
          const midPoint1 = Math.floor(i * segmentLength + segmentLength / 3);
          const midPoint2 = Math.floor(
            i * segmentLength + (2 * segmentLength) / 3
          );

          const P1 =
            (waveform[midPoint1] +
              waveform[midPoint1 - 1] +
              waveform[midPoint1 + 1]) /
            3;
          const P2 =
            (waveform[midPoint2] +
              waveform[midPoint2 - 1] +
              waveform[midPoint2 + 1]) /
            3;

          controlPoints.push({ P0, P1, P2, P3 });
        }

        // Add the final segment's endpoint
        controlPoints.push({
          P0: waveform[segmentCount * segmentLength],
          P1: waveform[waveform.length - 3],
          P2: waveform[waveform.length - 2],
          P3: waveform[waveform.length - 1],
        });

        return controlPoints;
      }

      function decodeBezierControlPointsToWaveform(controlPoints, length) {
        const decodedWaveform = new Array(length).fill(0);
        const segmentCount = NUMBER_OF_POINTS - 1;
        const segmentLength = Math.floor(length / segmentCount);

        for (let i = 0; i < segmentCount; i++) {
          const { P0, P1, P2, P3 } = controlPoints[i];

          for (let t = 0; t <= 1; t += 1 / segmentLength) {
            const x = i * segmentLength + t * segmentLength;
            const index = Math.floor(x);

            const B_t =
              (1 - t) ** 3 * P0 +
              3 * (1 - t) ** 2 * t * P1 +
              3 * (1 - t) * t ** 2 * P2 +
              t ** 3 * P3;
            decodedWaveform[index] = B_t;
          }
        }

        return decodedWaveform;
      }

      function drawWaveform(canvasId, waveform) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext("2d");

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.beginPath();
        ctx.moveTo(0, canvas.height / 2);

        for (let i = 0; i < waveform.length; i++) {
          const x = i;
          const y = canvas.height / 2 - waveform[i] * (canvas.height / 2);
          ctx.lineTo(x, y);
        }

        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      function processWaveform() {
        const waveformInput = document.getElementById("waveformInput").value;
        let waveform = JSON.parse(waveformInput);

        if (waveform.length !== 1024) {
          alert(
            "Please ensure the waveform array contains exactly 1024 elements."
          );
          return;
        }

        // Encode waveform to BÃ©zier control points
        const controlPoints = encodeWaveformToBezierControlPoints(waveform);

        // Decode the control points back to a waveform
        const decodedWaveform = decodeBezierControlPointsToWaveform(
          controlPoints,
          1024
        );

        // Draw the original and decoded waveforms
        drawWaveform("originalCanvas", waveform);
        drawWaveform("decodedCanvas", decodedWaveform);
      }
    </script>
  </body>
</html>
